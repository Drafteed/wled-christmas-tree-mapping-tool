<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <title>WLED Christmas Tree Configurator</title>
  <style>
    body {
      font-family: sans-serif;
      font-size: 18px;
      line-height: 150%;

      -webkit-text-size-adjust: 100%;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    a {
      color: inherit;
    }

    table {
      border-collapse: separate;
      border-spacing: 20px 5px;
    }

    section {
      padding: 20px;
      margin: 10px 0;

      background: #FCF3FE;
      border-radius: 10px;
    }

    section:nth-child(2n) {
      background: #FBF7EA;
    }

    section#section_info {
      color: #fff;
      background: #772AB9;
    }

    section#section_error {
      color: #fff;
      background: #E85049;
    }

    .grid {
      display: grid;
      grid-auto-flow: column;
      justify-content: start;
      align-items: center;
      gap: 20px;
    }

    .tree {
      width: 120px;
    }

    .header,
    .group {
      margin: 10px 0;
    }

    .header h2,
    .header h3 {
      margin: 0;
    }

    .submit {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }

    input[type=text],
    input[type=number],
    textarea {
      height: 28px;

      border: 0;
      border-radius: 5px;
      background: #fff;

      font-size: 16px;
    }

    textarea {
      width: 100%;
      height: 400px;
    }

    button {
      height: 28px;
      padding: 0 30px;

      cursor: pointer;
      color: #fff;
      border: 0;
      border-radius: 5px;
      background: #772AB9;

      font-size: 16px;

      transition: background 0.2s;
    }

    button:hover,
    button:focus {
      background: #8D4AD3;
    }

    button:disabled {
      opacity: 0.7;
      pointer-events: none;
    }

    hr {
      height: 1px;
      margin: 15px 0;

      border: none;
      background: #252525;
    }

    .text {
      max-width: 800px;
    }
  </style>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
<div id="root"></div>

<script type="text/babel">
  const {useRef, useState} = React;

  function App() {
    const connection = useRef(null);
    const connectionTimer = useRef(null);

    const [ip, setIp] = useState('wled-37fdb1.local');
    const [started, setStarted] = useState(false);
    const [connected, setConnected] = useState(false);
    const [error, setError] = useState(false);
    const [imported, setImported] = useState(false);
    const [count, setCount] = useState(0);
    const [selectedLed, setSelectedLed] = useState(0);
    const [selectedLedEnd, setSelectedLedEnd] = useState('');

    const [width, setWidth] = useState('');
    const [height, setHeight] = useState('');
    const [rows, setRows] = useState([{offset: 0}, {offset: 0}, {offset: 0}]);
    const [mapping, setMapping] = useState('');

    async function start() {
      await connect();
      await importMapping();
    }

    async function connect() {
      connection.current = new WebSocket(`ws://${ip}/ws`);

      connection.current.addEventListener('open', () => {
        setConnected(true);
        setError(false);
      });

      connection.current.addEventListener('message', (event) => {
        const data = JSON.parse(event.data);
        setCount(data?.info?.leds?.count);
        setStarted(true);
      });

      connection.current.addEventListener('error', () => {
        connection.current.close();
        setError(true);
        setConnected(false);
      });

      connection.current.addEventListener('close', () => {
        if (connectionTimer.current) return;
        connectionTimer.current = setTimeout(async () => {
          connectionTimer.current = null;
          await connect();
        }, 1000);
      });
    }

    async function importMapping() {
      try {
        const res = await fetch(`http://${ip}/edit?edit=%2Fledmap.json`);
        const data = await res.json();
        if (data.width && data.height && data.height) {
          setWidth(data.width);
          setHeight(data.height);
          const rows = Array.from({length: data.height}, (_, i) => {
            const row = data.map.slice(i * data.width, i * data.width + data.width);
            const offset = Math.round(((row.findIndex(v => v !== -1) + row.findLastIndex(v => v !== -1)) / 2) - (row.length - 1) / 2);
            return {
              left: row.find(v => v !== -1),
              right: row.findLast(v => v !== -1),
              offset: offset,
            };
          });
          setRows(rows.reverse());
          setImported(true);
        } else {
          setImported(false);
        }
      } catch {
        setImported(false);
      }
    }

    async function exportMapping() {
      try {
        const formData = new FormData();
        const blob = new Blob([mapping], {type: 'text/json'});
        formData.append('data', blob, '/ledmap.json');
        await fetch(`http://${ip}/edit`, {
          method: 'POST',
          body: formData,
        });
        alert('Mapping uploaded!');
      } catch {
        alert('Failed saving ledmap.json');
      }
    }

    async function configure2DMatrix() {
      try {
        await fetch(`http://${ip}/settings/2D`, {
          method: 'POST',
          body: `SOMP=1&PW=8&PH=8&MPH=1&MPV=1&PB=0&PR=0&PV=0&MPC=1&P0B=0&P0R=0&P0V=0&P0W=${width}&P0H=${height}&P0X=0&P0Y=0&data=`,
        });
        alert('2D matrix successfully configured!');
      } catch {
        alert('Failed configure 2D matrix in WLED');
      }
    }

    async function reboot() {
      try {
        await fetch(`http://${ip}/reset`);
        alert('Please wait ~10 seconds...');
      } catch {
        alert('Failed reboot WLED');
      }
    }

    async function highlightLED(start, end) {
      setSelectedLed(start);
      setSelectedLedEnd(end);
      connection.current.send(JSON.stringify({
        on: true,
        bri: 255,
        ledmap: 9, // to avoid affect current ledmap
        seg: {
          i: [0, count, '000000', start, end ? end + 1 : start, 'FFFFFF'],
          rev: false,
          mi: false,
        },
      }));
    }

    async function highlightCenterLEDs() {
      const centerLeds = rows.reduce((a, v) => {
        return [...a, Math.round((parseInt(v.left) + parseInt(v.right)) / 2) + parseInt(v.offset)];
      }, []);
      connection.current.send(JSON.stringify({
        on: true,
        bri: 255,
        ledmap: 10, // to avoid affect current ledmap
        seg: {
          i: [0, count, '000000', ...centerLeds.flatMap(x => [x, 'FFFFFF'])],
          rev: false,
          mi: false,
        },
      }));
    }

    async function testWLED() {
      connection.current.send(JSON.stringify({
        on: true,
        bri: 255,
        ledmap: 0,
        seg: {
          fx: 180,
          pal: 48,
          frz: false,
        },
      }));
    }

    function generateMatrix(ranges) {
      const height = ranges.length;
      let width = 0;

      for (const [start, end, offset = 0] of ranges) {
        const len = Math.abs(end - start) + 1;
        const requiredWidth = len + Math.abs(offset) * 2;
        width = Math.max(width, requiredWidth);
      }

      const map = Array.from({length: height}, () =>
        Array(width).fill(-1),
      );

      for (let row = 0; row < height; row++) {
        let [start, end, offset = 0] = ranges[row];

        const step = start <= end ? 1 : -1;
        const values = [];

        for (let v = start; step > 0 ? v <= end : v >= end; v += step) {
          values.push(v);
        }

        const len = values.length;
        let startCol = Math.floor((width - len) / 2) + offset;

        for (let i = 0; i < len; i++) {
          map[row][startCol + i] = values[i];
        }
      }

      return {width, height, map};
    }

    function generateMapping() {
      const ranges = [...rows].map(r => [parseInt(r.left), parseInt(r.right), parseInt(r.offset)]).reverse();
      const isValid = ranges.every(a => a.every((n) => typeof n === 'number' && !isNaN(n)));

      if (!isValid) {
        alert('Please fill in all the values in the table!');
        return;
      }

      const matrix = generateMatrix(ranges);
      const json = `{"width":${matrix.width},"height":${matrix.height},"map":[\n` +
        matrix.map.map(r => r.toString()).join(',\n') +
        '\n]}';

      setMapping(json);
      setWidth(matrix.width);
      setHeight(matrix.height);
    }

    return (
      <>
        <section>
          <div className="header">
            <h3>Preparations</h3>
          </div>
          <div className="grid">
            <div className="grid__col">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 70 90" className="tree">
                <path fill="#6bb42e" d="M27.22 90V75.17H0l19.44-24.73H7.78l19.44-24.72H15.56L35 1l19.44 24.72H42.78l19.44 24.72H50.56L70 75.17H42.78V90z"/>
                <mask id="a" width="70" height="89" x="0" y="1" maskUnits="userSpaceOnUse" style={{maskType: 'alpha'}}>
                  <path fill="#6bb42e" d="M27.22 90V75.17H0l19.44-24.73H7.78l19.44-24.72H15.56L35 1l19.44 24.72H42.78l19.44 24.72H50.56L70 75.17H42.78V90z"/>
                </mask>
                <g stroke="#ffff05" strokeDasharray="0.1 3" strokeLinecap="round" mask="url(#a)">
                  <path d="M.5-.5h63.14" transform="matrix(-0.999391 -0.0348995 0.02673 -0.999643 67.0532 69.9836)"/>
                  <path d="M.5-.5h63.14" transform="matrix(-0.999391 -0.0348995 0.02673 -0.999643 68.0537 58.2383)"/>
                  <path d="M.5-.5h63.14" transform="matrix(-0.999391 -0.0348995 0.02673 -0.999643 69.0532 46.4919)"/>
                  <path d="M.5-.5h63.14" transform="matrix(-0.999391 -0.0348995 0.02673 -0.999643 69.0527 34.7468)"/>
                  <path d="M.5-.5h63.14" transform="matrix(-0.999391 -0.0348995 0.02673 -0.999643 72.0532 23.0005)"/>
                  <path d="M.5-.5h63.14" transform="matrix(-0.999391 -0.0348995 0.02673 -0.999643 74.0532 11.2554)"/>
                </g>
              </svg>
            </div>
            <div className="grid__col">
              <div className="text">
                <p>Wrap your addressable LED strip around the tree from bottom to top so that you get even
                  horizontal rows. Configure the required number of LEDs in WLED in the regular 1D
                  mode. Make sure everything works correctly. Also make sure that the
                  files <b>ledmap.json</b> (<b>ledmapX.json</b>) and <b>2d-gaps.json</b> are not
                  present in the WLED File Editor.</p>
              </div>
            </div>
          </div>
        </section>
        <section>
          WLED IP: <input type="text" value={ip} onChange={e => setIp(e.target.value)}/>
          <button onClick={start}>Connect</button>
        </section>

        {
          error && (
            <section id="section_error">
              üò¢ Error while connecting to WLED! Reconnecting...
            </section>
          )
        }

        {
          connected && (
            <section id="section_info">
              üëå Connected. LED count: {count}.{imported && ' Mapping imported.'}
            </section>
          )
        }

        {
          started && (
            <section>
              <div className="header">
                <h3>Let's generate your matrix!</h3>
              </div>
              <div className="text">
                <p>
                  üéÑ Take a look at your beautiful tree! Calculate the number of rows (lines) vertically and add the
                  corresponding number of rows. Then, for each row, find the <b>leftmost</b> and <b>rightmost</b> LED
                  number.
                </p>
                <p>
                  üîé The slider below will help you locate and identify the number of each LED.<br/>
                  ‚úÖ You can verify that the row is filled correctly by clicking the <b>Highlight row</b> button.<br/>
                  ‚ö†Ô∏è For the initial setup, you can leave the offsets at 0.<br/>
                  ‚ÑπÔ∏è After defining all lines, you can highlight the center of each row and fine-tune the offsets.
                </p>
              </div>

              <hr/>
              <div className="group">
                {connected ? (
                  <div className="group">
                    Highlighted LED Number: {selectedLed}{selectedLedEnd && ` - ${selectedLedEnd}`}
                  </div>
                ) : (
                  <div className="group" style={{color: 'red'}}>
                    WLED disconnected. Reconnecting...
                  </div>
                )}

                <input
                  type="range"
                  min="0"
                  max={count - 1}
                  disabled={!connected}
                  value={selectedLed}
                  onChange={e => highlightLED(parseInt(e.target.value))}
                  style={{width: '100%'}}
                />
              </div>
              <hr/>

              <table className="table">
                <tbody>
                {rows
                  .map((row, i) => (
                    <tr key={i}>
                      <td>Row {i + 1}</td>
                      <td>
                        Left LED:{' '}
                        <input
                          type="number"
                          min="0"
                          max={count - 1}
                          value={row.left}
                          onChange={(e) => {
                            const r = [...rows];
                            r[i].left = parseInt(e.target.value);
                            setRows(r);
                          }}
                        />
                      </td>
                      <td>
                        Right LED:{' '}
                        <input
                          type="number"
                          min="0"
                          max={count - 1}
                          value={row.right}
                          onChange={(e) => {
                            const r = [...rows];
                            r[i].right = parseInt(e.target.value);
                            setRows(r);
                          }}
                        />
                      </td>
                      <td>
                        Offset:{' '}
                        <input
                          type="number"
                          min={-count - 1}
                          max={count - 1}
                          value={row.offset}
                          onChange={(e) => {
                            const r = [...rows];
                            r[i].offset = parseInt(e.target.value);
                            setRows(r);
                          }}
                        />
                      </td>
                      <td>
                        <button
                          disabled={!connected}
                          onClick={() => {
                            const r = [...rows];
                            const left = parseInt(r[i].left);
                            const right = parseInt(r[i].right);
                            highlightLED(left < right ? left : right, right > left ? right : left);
                          }}
                        >
                          Highlight row
                        </button>
                      </td>
                      <td>
                        <button
                          onClick={() => {
                            setRows([...rows.slice(0, i), ...rows.slice(i + 1)]);
                          }}
                        >
                          Delete row
                        </button>
                      </td>
                    </tr>
                  ))
                  .reverse()}
                </tbody>
              </table>
              <div className="submit">
                <button onClick={generateMapping}>Generate mapping</button>
                <button onClick={() => setRows([...rows, {offset: 0}])}>Add row</button>
                <button disabled={!connected} onClick={highlightCenterLEDs}>
                  Highlight center of LEDs
                </button>
              </div>
            </section>
          )
        }

        {
          mapping && (
            <section>
              <div className="header">
                <h3>Magic is coming!</h3>
              </div>
              <div className="text">
                <p>
                  üéâ Your mapping is done!<br/>
                  Upload mapping to WLED, configure 2D matrix and reboot device.
                </p>
              </div>
              <textarea value={mapping} readOnly/>
              <div className="submit">
                <button disabled={!connected} onClick={exportMapping}>
                  Upload mapping to WLED
                </button>
                <button disabled={!connected} onClick={configure2DMatrix}>
                  Configure 2D matrix in WLED
                </button>
                <button disabled={!connected} onClick={reboot}>
                  Reboot WLED
                </button>
                <button disabled={!connected} onClick={testWLED}>
                  Test run
                </button>
              </div>
              <div className="text">
                <p>
                  <b>Manual configuration</b>:<br/>
                  Upload mapping to WLED via the <a href={`http://${ip}/edit`} target="_blank">File
                  Editor</a> into <b>/ledmap.json</b> (create the file if it does not exist).<br/> Then
                  setup <a href={`http://${ip}/settings/2D`} target="_blank">WLED into 2D
                  mode</a> in <b>Setup &gt; 2D Configuration &gt; 2D Matrix &gt; Panel Dimensions</b> and
                  enter your matrix dimensions (<b>{width}x{height}</b>).<br/>
                  Save and <a href={`http://${ip}/reset`} target="_blank">fully reboot WLED</a>.
                </p>
              </div>
            </section>
          )
        }
      </>
    );
  }

  ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
</script>
</body>
</html>
