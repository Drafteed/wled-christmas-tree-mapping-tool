<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <title>WLED Christmas Tree Configurator</title>
  <style>
    body {
      font-family: sans-serif;
      font-size: 18px;
      line-height: 150%;

      -webkit-text-size-adjust: 100%;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    a {
      color: inherit;
    }

    table {
      border-collapse: separate;
      border-spacing: 20px 5px;
    }

    section {
      padding: 20px;
      margin: 10px 0;

      background: #FCF3FE;
      border-radius: 10px;
    }

    section:nth-child(2n) {
      background: #FBF7EA;
    }

    section#section_info {
      color: #fff;
      background: #772AB9;
    }

    section#section_error {
      color: #fff;
      background: #E85049;
    }

    .grid {
      display: grid;
      grid-auto-flow: column;
      justify-content: start;
      align-items: center;
      gap: 20px;
    }

    .tree {
      width: 120px;
    }

    .header,
    .group {
      margin: 10px 0;
    }

    .header h2,
    .header h3 {
      margin: 0;
    }

    .notice {
      color: #888888;

      font-size: 14px;
    }

    .submit {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }

    input[type=text],
    input[type=number],
    textarea {
      height: 28px;

      border: 0;
      border-radius: 5px;
      background: #fff;

      font-size: 16px;
    }

    textarea {
      width: 100%;
      height: 400px;
    }

    button {
      height: 28px;
      padding: 0 30px;

      cursor: pointer;
      color: #fff;
      border: 0;
      border-radius: 5px;
      background: #772AB9;

      font-size: 16px;

      transition: background 0.2s;
    }

    button:hover,
    button:focus {
      background: #8D4AD3;
    }

    hr {
      height: 1px;
      margin: 15px 0;

      border: none;
      background: #252525;
    }

    .text {
      max-width: 800px;
    }
  </style>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
<div id="root"></div>

<script type="text/babel">
  const {useState} = React;

  function generateMatrix(width, height, ranges) {
    const matrix = Array.from({length: height}, () =>
      Array(width).fill(-1),
    );

    for (let row = 0; row < height; row++) {
      let [start, end, offset = 0] = ranges[row];
      const step = start <= end ? 1 : -1;

      const values = [];
      for (let v = start; step > 0 ? v <= end : v >= end; v += step) {
        values.push(v);
      }

      const len = values.length;
      let startCol = Math.floor((width - len) / 2) + offset;
      if (startCol < 0) startCol = 0;
      if (startCol + len > width) startCol = width - len;

      for (let i = 0; i < len; i++) {
        matrix[row][startCol + i] = values[i];
      }
    }

    return matrix;
  }

  function App() {
    const [ip, setIp] = useState('wled-37fdb1');
    const [connected, setConnected] = useState(false);
    const [error, setError] = useState(false);
    const [count, setCount] = useState(0);
    const [selectedLed, setSelectedLed] = useState('X');

    const [width, setWidth] = useState('');
    const [height, setHeight] = useState('');
    const [rows, setRows] = useState([]);
    const [mapping, setMapping] = useState('');

    async function connect() {
      try {
        const res = await fetch(`http://${ip}/json/info`);
        if (!res.ok) throw new Error();
        const data = await res.json();
        setCount(data.leds.count);
        setConnected(true);
        setError(false);
        await importMapping();
      } catch {
        setError(true);
        setConnected(false);
      }
    }

    async function importMapping() {
      try {
        const res = await fetch(`http://${ip}/edit?edit=%2Fledmap.json`);
        const data = await res.json();
        if (data?.width) setWidth(data.width);
        if (data?.height) setHeight(data.height);
        if (data?.map) {
          const map = data?.map;
          // todo: check map dimensions
          const rows = Array.from({length: data.height}, (_, i) => {
            const row = map.slice(i * data.width, i * data.width + data.width);
            return {
              left: row.find(v => v !== -1),
              right: row.findLast(v => v !== -1),
              offset: 0,
            };
          });
          setRows(rows.reverse());
        }
      } catch {}
    }

    async function exportMapping() {
      try {
        const formData = new FormData();
        const blob = new Blob([mapping], {type: 'text/json'});
        formData.append('data', blob, '/ledmap.json');
        await fetch(`http://${ip}/edit`, {
          method: 'POST',
          body: formData,
        });
        alert('Mapping uploaded!');
      } catch {
        alert('Failed saving ledmap.json');
      }
    }

    async function reboot() {
      try {
        await fetch(`http://${ip}/reset`);
        alert('Wait up to 30 seconds for WLED to reboot...');
      } catch {
        alert('Failed reboot WLED');
      }
    }

    async function highlightLED(start, end) {
      setSelectedLed(end !== undefined ? `${start} - ${end}` : start);
      await fetch(`http://${ip}/json/state`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          on: true,
          bri: 255,
          seg: {
            i: [0, count, '000000', start, end ? end + 1 : start, 'FFFFFF'],
            rev: false,
            mi: false,
          },
        }),
      });
    }

    function generateEditor() {
      setRows(
        Array.from({length: height}, () => ({
          left: '',
          right: '',
          offset: 0,
        })),
      );
    }

    function generateMapping() {
      const ranges = [...rows].map(r => [parseInt(r.left), parseInt(r.right), parseInt(r.offset)]).reverse();
      const matrix = generateMatrix(parseInt(width), parseInt(height), ranges);
      const json = `{"width":${width},"height":${height},"map":[\n` +
        matrix.map(r => r.toString()).join(',\n') +
        '\n]}';

      setMapping(json);
    }

    return (
      <>
        <section>
          <div className="header">
            <h3>Preparations</h3>
          </div>
          <div className="grid">
            <div className="grid__col">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 70 90" className="tree">
                <path fill="#6bb42e" d="M27.22 90V75.17H0l19.44-24.73H7.78l19.44-24.72H15.56L35 1l19.44 24.72H42.78l19.44 24.72H50.56L70 75.17H42.78V90z"/>
                <mask id="a" width="70" height="89" x="0" y="1" maskUnits="userSpaceOnUse" style={{maskType: 'alpha'}}>
                  <path fill="#6bb42e" d="M27.22 90V75.17H0l19.44-24.73H7.78l19.44-24.72H15.56L35 1l19.44 24.72H42.78l19.44 24.72H50.56L70 75.17H42.78V90z"/>
                </mask>
                <g stroke="#ffff05" strokeDasharray="0.1 3" strokeLinecap="round" mask="url(#a)">
                  <path d="M.5-.5h63.14" transform="matrix(-0.999391 -0.0348995 0.02673 -0.999643 67.0532 69.9836)"/>
                  <path d="M.5-.5h63.14" transform="matrix(-0.999391 -0.0348995 0.02673 -0.999643 68.0537 58.2383)"/>
                  <path d="M.5-.5h63.14" transform="matrix(-0.999391 -0.0348995 0.02673 -0.999643 69.0532 46.4919)"/>
                  <path d="M.5-.5h63.14" transform="matrix(-0.999391 -0.0348995 0.02673 -0.999643 69.0527 34.7468)"/>
                  <path d="M.5-.5h63.14" transform="matrix(-0.999391 -0.0348995 0.02673 -0.999643 72.0532 23.0005)"/>
                  <path d="M.5-.5h63.14" transform="matrix(-0.999391 -0.0348995 0.02673 -0.999643 74.0532 11.2554)"/>
                </g>
              </svg>
            </div>
            <div className="grid__col">
              <div className="text">
                <p>Wrap your addressable LED strip around the tree from bottom to top so that you get even
                  horizontal rows. Configure the required number of LEDs in WLED in the regular 1D
                  mode. Make sure everything works correctly. Also make sure that the
                  files <b>ledmap.json</b> (<b>ledmapX.json</b>) and <b>2d-gaps.json</b> are not
                  present in the WLED File Editor.</p>
              </div>
            </div>
          </div>
        </section>
        <section>
          WLED IP: <input type="text" value={ip} onChange={e => setIp(e.target.value)}/>
          <button onClick={connect}>Connect</button>
        </section>

        {
          error && (
            <section id="section_error">
              Error while connecting to WLED!
            </section>
          )
        }

        {
          connected && (
            <section id="section_info">
              Connected. LED count: {count}.
            </section>
          )
        }

        {
          connected && (
            <section>
              <div className="header">
                <h3>Let's generate your matrix!</h3>
              </div>
              <div className="text">
                <p>
                  üéÑ Take a look at your beautiful tree! Count the number of LEDs in the longest horizontal
                  row (usually
                  the bottom one) and enter this number in the Width field. Then count the number of
                  horizontal rows and enter
                  that number in the Height field.
                </p>
              </div>
              <div className="group">
                Width (max led's in one horizontal line):
              </div>
              <div className="group">
                <input type="number" min="1" value={width} onChange={e => setWidth(e.target.value)}/>
              </div>
              <div className="group">
                Height (horizontal lines count):
              </div>
              <div className="group">
                <input type="number" min="1" value={height} onChange={e => setHeight(e.target.value)}/>
              </div>
              <div className="submit">
                <button onClick={generateEditor}>Generate</button>
              </div>
            </section>
          )
        }

        {
          rows.length > 0 && (
            <section>
              <div className="header">
                <h3>Now let's create the mapping!</h3>
              </div>
              <div className="text">
                <p>
                  ‚úÖ Now find the number of the leftmost and rightmost LED in each horizontal line.<br/>
                  ‚ö†Ô∏è For initial setup, leave the offsets at 0.<br/>
                  üîé Use the slider below to find the number of each LED.
                </p>
              </div>

              <hr/>
              <div className="group">
                <div className="group">
                  Highlighted LED Number: {selectedLed}
                </div>
                <input
                  type="range"
                  min="0"
                  max={count - 1}
                  value={selectedLed}
                  onChange={e => highlightLED(parseInt(e.target.value))}
                  style={{width: '100%'}}
                />
              </div>
              <div className="notice">‚ÑπÔ∏è Note: If the slider is not working correctly, delete
                the <b>/ledmap.json</b> file
                from the <a href={`http://${ip}/edit`} target="_blank">File Editor</a>,
                put <a href={`http://${ip}/settings/2D`} target="_blank">WLED into 1D mode</a>,
                and <a href={`http://${ip}/reset`} target="_blank">fully reboot WLED</a>.
              </div>
              <hr/>

              <table className="table">
                <tbody>
                {rows.map((row, i) => (
                  <tr key={i}>
                    <td>
                      Line {i}
                    </td>
                    <td>
                      Left LED: <input
                      type="number"
                      min="0"
                      max={count - 1}
                      value={row.left}
                      onChange={e => {
                        const r = [...rows];
                        r[i].left = e.target.value;
                        setRows(r);
                      }}
                    />
                    </td>
                    <td>
                      Right LED: <input
                      type="number"
                      min="0"
                      max={count - 1}
                      value={row.right}
                      onChange={e => {
                        const r = [...rows];
                        r[i].right = e.target.value;
                        setRows(r);
                      }}
                    /></td>
                    <td>
                      Offset: <input
                      type="number"
                      min={-width}
                      max={width}
                      value={row.offset}
                      onChange={e => {
                        const r = [...rows];
                        r[i].offset = e.target.value;
                        setRows(r);
                      }}
                    />
                    </td>
                    <td>
                      <button onClick={() => {
                        const r = [...rows];
                        const left = parseInt(r[i].left);
                        const right = parseInt(r[i].right);
                        highlightLED(left < right ? left : right, right > left ? right : left);
                      }}>
                        Highlight row
                      </button>
                    </td>
                  </tr>
                )).reverse()}
                </tbody>
              </table>
              <div className="submit">
                <button onClick={generateMapping}>Get mapping</button>
              </div>
            </section>
          )
        }

        {
          mapping && (
            <section>
              <div className="header">
                <h3>Magic is coming!</h3>
              </div>
              <div className="text">
                <p>
                  üéâ Your mapping is done!
                </p>
                <p>
                  Upload it to WLED via the <a href={`http://${ip}/edit`} target="_blank">File
                  Editor</a> into <b>/ledmap.json</b> (create the file if it does not exist).<br/> Then
                  put <a href={`http://${ip}/settings/2D`} target="_blank">WLED into 2D
                  mode</a> in <b>Setup &gt; 2D Configuration &gt; 2D Matrix &gt; Panel Dimensions</b> and
                  enter your matrix dimensions (<b>{width}x{height}</b>).<br/>
                  Save and <a href={`http://${ip}/reset`} target="_blank">fully reboot WLED</a>.
                </p>
                <p>
                  ‚ÑπÔ∏è You can use the offsets to tweak the horizontal alignment of the rows relative to
                  each other.
                </p>
              </div>
              <textarea value={mapping} readOnly/>
              <div className="submit">
                <button onClick={exportMapping}>Upload mapping to WLED</button>
                <button onClick={reboot}>Reboot WLED</button>
              </div>
            </section>
          )
        }
      </>
    );
  }

  ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
</script>
</body>
</html>
